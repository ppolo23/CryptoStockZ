# Smart Contracts

## Description

The Smart Contracts of our application have been implemented through the Solidity programming language version 0.6.0 [2] and the Truffle development environment [3], which has allowed the testing and deployment of smart contracts in a Ganache node [4].
 
In total, six Smart Contracts have been developed: CryptoStockZ.sol, StockZStorage.sol, Product.sol, ProductToken.sol, ProductLogic.sol and Ownable.sol.
 
CryptoStockZ.sol is the main contract of our application. It contains the functions that allow the creation, transfer and update of the most important element of the system, digital products, and which are called by users from the visual component of the application. The execution of these functions emits the events that are collected by the Frontend in order to apply the corresponding changes in the database raised in the Backend, thus maintaining consistency between both parties.
In addition, it has the necessary functions to link this contract with StockZStorage.sol, responsible for storing all the permanently registered products. In this way, it is possible to separate the application logic from its storage, which makes it possible to carry out updates or modifications in the functional part of the system, keeping the data accessible for the successive versions of the logic that must be deployed in the Blockchain.
 
Thus, the StockZStorage.sol contract has been developed applying the Eternal Storage design pattern [5] and has the necessary functions and data structures to store the products registered in the application. In turn, as each product is associated with a token, the storage of said association has been programmed through a mapping of positions, saving the tokens in another ProductToken.sol contract
 
The Product.sol contract implements the digital representation of the products, with the attributes that abstract the qualities of these elements (base_id, unique_id, dna and level) and the functions necessary for updating and consulting them (getters and setters).
 
On the other hand, the ProductTokens.sol contract is another of the most important contracts of our dapp, on the one hand it inherits the ERC721 smart contract, also developed by OpenZeppelin, it implements a type of tokens called non-fungible tokens, that is, tokens that do not They can be separated, the user who owns a token owns a token but cannot own half a token or a quarter of a token. ProductToken, associates a product with an address (its owner) turning this product into a non-fungible token. On the other hand, productToken saves all these tokens following the ERC721 design pattern.
An advantage of following this pattern is the fact that you can change the type of token used later since all ERCs developed by OpenZeppelin follow the same structure.
 
For its part, the ProductLogic.sol contract contains the logic related to the products. This logic is summarized in the treatment of the DNA of the products for their update, mixing it with the address of the new owner of the product when it is transferred.
In addition, this contract includes the use of SafeMath.sol, a Smart Contract developed by the OpenZeppelin company [6] to perform arithmetic functions within the blockchain in a secure way.
 
Finally, we have implemented our own version of Ownable in the Ownable.sol contract. It contains everything necessary to control the property of the products, thus limiting the access and handling of the products to their legitimate owners.

## Deployment

The smart contracts described in the previous section and contained in the 'contracts' folder have been deployed and tested on a local network generated by Ganache.

The main deployment script is located in the 'migrations' folder under the name '2_dapp_migration.js', which allows you to deploy the contracts 'CryptoStockZ.sol' and 'StockZStorage.sol' while establishing the link between both contracts.

In this way, it is enough to carry out the following steps to put the testnet and contracts into operation:

### Start Ganache
```bash
ganache-cli --accounts 10 --defaultBalanceEther 100 --deterministic cryptostockz --port 8545 --allowUnlimitedContractSize
```

### Compile the contracts
```bash
truffle compile
```

### Migrate contracts
```bash
truffle migrate
```
